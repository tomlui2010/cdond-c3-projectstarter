- name : Copy build files to target host
  copy:
    src: /root/project/artifact.tar.gz
    dest: /home/ubuntu/artifact.tar.gz

- name: Extract artifact.tar.gz
  become: yes
  command: |
    tar -xzvf /home/ubuntu/artifact.tar.gz -C /home/ubuntu

- name: Install npm
  become: yes
  package:
    name: npm
    state: present

- name: Check if default PM2 process is running
  become: yes
  shell: pm2 list | grep -q 'default'
  register: default_pm2_running
  ignore_errors: true

- name: Stop default PM2 process
  become: yes
  command: pm2 stop default
  when: default_pm2_running.rc == 0

- name: Start PM2 process
  become: yes
  command: pm2 start -f /home/ubuntu/dist/main.js
  environment:
    Environment: production
    TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION') }}"
    TYPEORM_MIGRATIONS_DIR: "./migrations"
    TYPEORM_MIGRATIONS: "./migrations/*.js"
    TYPEORM_ENTITIES: "./modules/domain/**/*.entity.js"
    TYPEORM_HOST: "{{ lookup('env', 'TYPEORM_HOST') }}"
    TYPEORM_PORT: "{{ lookup('env', 'TYPEORM_PORT') }}"
    TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME') }}"
    TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD') }}"
    TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE') }}"
